networks:
  hytopia-net:
    driver: bridge
    
services:
  hytopia-dev:
    build:
      context: ./dev-server
      dockerfile: Dockerfile
    command: /app/core/utils/setup-env.sh  # Runs setup and provides shell
    stdin_open: true  # Keep STDIN open
    tty: true        # Allocate a pseudo-TTY
    ports:
      - "${HYTOPIA_PORT:-8080}:8080"
    volumes:
      - ./dev-server:/app/core
      - ./examples:/app/games/examples
      - ./custom-repos:/app/games/custom-repos
      - ./state:/app/state
      - ./logs:/app/logs
      - ./backups:/app/backups
    environment:
      - NODE_ENV=development
      - BUN_ENV=development
      - ENABLE_OFFICIAL_EXAMPLES=${ENABLE_OFFICIAL_EXAMPLES:-true}
      - CUSTOM_REPO_1=${CUSTOM_REPO_1:-}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
      - TUNNEL_DOMAIN=${TUNNEL_DOMAIN:-}
      - CUSTOM_DOMAIN=${CUSTOM_DOMAIN:-}
      - CUSTOM_DOMAIN_DNS_RECORD=${CUSTOM_DOMAIN_DNS_RECORD:-}
      - HYTOPIA_PORT=${HYTOPIA_PORT:-8080}
    networks:
      - hytopia-net

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    volumes:
      - ./cloudflared:/etc/cloudflared
    networks:
      - hytopia-net
